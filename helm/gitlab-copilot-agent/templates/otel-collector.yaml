{{- if .Values.telemetry.otlpEndpoint }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "app.fullname" . }}-otel-collector
  labels: {{- include "app.labels" . | nindent 4 }}
data:
  config.yaml: |
    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: 0.0.0.0:4317
      kubeletstats:
        collection_interval: 30s
        auth_type: serviceAccount
        endpoint: "https://${env:NODE_NAME}:10250"
        insecure_skip_verify: true
      filelog:
        include: [/var/log/pods/*/*/*.log]
        operators:
          - type: container
            id: container-parser
    exporters:
      otlp:
        endpoint: {{ .Values.telemetry.otlpEndpoint | quote }}
        tls:
          insecure: {{ not (hasPrefix "https" .Values.telemetry.otlpEndpoint) }}
    processors:
      batch:
        timeout: 10s
      k8sattributes:
        extract:
          metadata: [k8s.pod.name, k8s.namespace.name, k8s.node.name]
    service:
      pipelines:
        traces:
          receivers: [otlp]
          processors: [batch, k8sattributes]
          exporters: [otlp]
        metrics:
          receivers: [otlp, kubeletstats]
          processors: [batch, k8sattributes]
          exporters: [otlp]
        logs:
          receivers: [otlp, filelog]
          processors: [batch, k8sattributes]
          exporters: [otlp]
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: {{ include "app.fullname" . }}-otel-collector
  labels: {{- include "app.labels" . | nindent 4 }}
spec:
  selector:
    matchLabels:
      app.kubernetes.io/component: otel-collector
      {{- include "app.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      labels:
        app.kubernetes.io/component: otel-collector
        {{- include "app.selectorLabels" . | nindent 8 }}
    spec:
      serviceAccountName: {{ include "app.fullname" . }}-otel-collector
      containers:
        - name: collector
          image: "{{ .Values.telemetry.collector.image.repository }}:{{ .Values.telemetry.collector.image.tag }}"
          args: ["--config=/etc/otelcol/config.yaml"]
          ports: [{ containerPort: 4317, protocol: TCP }]
          env:
            - name: NODE_NAME
              valueFrom: { fieldRef: { fieldPath: spec.nodeName } }
          volumeMounts:
            - name: config
              mountPath: /etc/otelcol
            - name: varlogpods
              mountPath: /var/log/pods
              readOnly: true
          resources: {{- toYaml .Values.telemetry.collector.resources | nindent 12 }}
      volumes:
        - name: config
          configMap: { name: {{ include "app.fullname" . }}-otel-collector }
        - name: varlogpods
          hostPath: { path: /var/log/pods }
---
apiVersion: v1
kind: Service
metadata:
  name: {{ include "app.fullname" . }}-otel-collector
  labels: {{- include "app.labels" . | nindent 4 }}
spec:
  type: ClusterIP
  ports:
    - port: 4317
      targetPort: 4317
      protocol: TCP
      name: otlp-grpc
  selector:
    app.kubernetes.io/component: otel-collector
    {{- include "app.selectorLabels" . | nindent 4 }}
{{- end }}
